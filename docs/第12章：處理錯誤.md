# 第十二章：處理錯誤

在上一章中，您學習了如何使用 Server Actions 來修改資料。接下來，讓我們看看如何使用 JavaScript 的 `try/catch` 語句和 Next.js API 來優雅地處理錯誤和未捕獲的異常。

## 在本章中...

以下是我們將涵蓋的主題：

- 如何使用特殊的 `error.tsx` 檔案來捕獲路由區段中的錯誤，並向使用者顯示一個備用 UI。
- 如何使用 `notFound` 函數和 `not-found` 檔案來處理 404 錯誤（針對不存在的資源）。

## 為 Server Actions 添加 `try/catch`

首先，讓我們為您的 Server Actions 添加 JavaScript 的 `try/catch` 語句，以便優雅地處理錯誤。

如果您知道如何做，可以花幾分鐘時間更新您的 Server Actions，或者您可以複製下面的程式碼：

`/app/lib/actions.ts` (`createInvoice`)

```ts
export async function createInvoice(formData: FormData) {
  const { customerId, amount, status } = CreateInvoice.parse({
    customerId: formData.get("customerId"),
    amount: formData.get("amount"),
    status: formData.get("status"),
  });

  const amountInCents = amount * 100;
  const date = new Date().toISOString().split("T")[0];

  try {
    await sql`
      INSERT INTO invoices (customer_id, amount, status, date)
      VALUES (${customerId}, ${amountInCents}, ${status}, ${date})
    `;
  } catch (error) {
    // 暫時我們也將錯誤記錄到控制台
    console.error(error);
    return {
      message: "Database Error: Failed to Create Invoice.",
    };
  }

  revalidatePath("/dashboard/invoices");
  redirect("/dashboard/invoices");
}
```

`/app/lib/actions.ts` (`updateInvoice`)

```ts
export async function updateInvoice(id: string, formData: FormData) {
  const { customerId, amount, status } = UpdateInvoice.parse({
    customerId: formData.get("customerId"),
    amount: formData.get("amount"),
    status: formData.get("status"),
  });

  const amountInCents = amount * 100;

  try {
    await sql`
        UPDATE invoices
        SET customer_id = ${customerId}, amount = ${amountInCents}, status = ${status}
        WHERE id = ${id}
      `;
  } catch (error) {
    // 暫時我們也將錯誤記錄到控制台
    console.error(error);
    return { message: "Database Error: Failed to Update Invoice." };
  }

  revalidatePath("/dashboard/invoices");
  redirect("/dashboard/invoices");
}
```

請注意 `redirect` 是如何在 `try/catch` 區塊之外被呼叫的。這是因為 `redirect` 是透過拋出一個錯誤來運作的，這個錯誤會被 `catch` 區塊捕獲。為避免這種情況，您可以在 `try/catch` 之後呼叫 `redirect`。只有當 `try` 成功時，`redirect` 才會被執行到。

我們透過捕捉資料庫問題，並從我們的 Server Action 中返回一個有用的訊息來優雅地處理這些錯誤。

如果您的 action 中出現了**未捕獲的異常**，會發生什麼事？我們可以透過手動拋出一個錯誤來模擬這種情況。例如，在 `deleteInvoice` action 中，在函數頂部拋出一個錯誤：

`/app/lib/actions.ts`

```ts
export async function deleteInvoice(id: string) {
  throw new Error("Failed to Delete Invoice");

  // 無法到達的程式碼區塊
  await sql`DELETE FROM invoices WHERE id = ${id}`;
  revalidatePath("/dashboard/invoices");
}
```

當您嘗試刪除一筆發票時，您應該會在 localhost 上看到錯誤。在生產環境中，當發生意外情況時，您會希望更優雅地向使用者顯示一條訊息。

這就是 Next.js 的 `error.tsx` 檔案發揮作用的地方。在測試後和進入下一節之前，請確保**移除**這個手動添加的錯誤。

## 使用 `error.tsx` 處理所有錯誤

`error.tsx` 檔案可用於為路由區段定義一個 UI 邊界。它作為未預期錯誤的「全部捕獲」機制，並允許您向使用者顯示一個備用 UI (fallback UI)。

在您的 `/dashboard/invoices` 資料夾內，建立一個名為 `error.tsx` 的新檔案並貼上以下程式碼：

`/app/dashboard/invoices/error.tsx`

```tsx
"use client";

import { useEffect } from "react";

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    // 可選地將錯誤記錄到錯誤報告服務
    console.error(error);
  }, [error]);

  return (
    <main className="flex h-full flex-col items-center justify-center">
      <h2 className="text-center">Something went wrong!</h2>
      <button
        className="mt-4 rounded-md bg-blue-500 px-4 py-2 text-sm text-white transition-colors hover:bg-blue-400"
        onClick={
          // 嘗試透過重新渲染發票路由來恢復
          () => reset()
        }
      >
        Try again
      </button>
    </main>
  );
}
```

關於上面的程式碼，您會注意到幾件事：

- `"use client"` - `error.tsx` 需要是一個客戶端元件 (Client Component)。
- 它接受兩個 props：
  - `error`: 這個物件是 JavaScript 原生 `Error` 物件的一個實例。
  - `reset`: 這是一個用來重設錯誤邊界的函數。執行時，該函數將嘗試重新渲染路由區段。

當您再次嘗試刪除一筆發票時，您應該會看到以下 UI。

## 使用 `notFound` 函數處理 404 錯誤

另一種優雅處理錯誤的方法是使用 `notFound` 函數。雖然 `error.tsx` 對於捕捉未預期的異常很有用，但 `notFound` 可用於當您嘗試獲取一個不存在的資源時。

例如，訪問 `http://localhost:3000/dashboard/invoices/2e94d1ed-d220-449f-9f11-f0bbceed9645/edit`。

這是一個偽造的 UUID，在您的資料庫中並不存在。您會立即看到 `error.tsx` 生效，因為這是一個定義了 `error.tsx` 的 `/invoices` 的子路由。

然而，如果您想更具體地處理，您可以顯示一個 404 錯誤，告訴使用者他們試圖存取的資源未被找到。

您可以進入 `data.ts` 中的 `fetchInvoiceById` 函數，並為返回的發票添加一個 `console.log` 來確認資源不存在：

`/app/lib/data.ts`

```ts
export async function fetchInvoiceById(id: string) {
  try {
    // ...

    console.log(invoice); // invoice 是一個空陣列 []
    return invoice[0];
  } catch (error) {
    console.error("Database Error:", error);
    throw new Error("Failed to fetch invoice.");
  }
}
```

現在您知道發票在您的資料庫中不存在，讓我們使用 `notFound` 來處理它。導航到 `/dashboard/invoices/[id]/edit/page.tsx`，並從 `next/navigation` 匯入 `{ notFound }`。

然後，您可以使用一個條件式來在發票不存在時調用 `notFound`：

`/app/dashboard/invoices/[id]/edit/page.tsx`

```tsx
import { fetchInvoiceById, fetchCustomers } from "@/app/lib/data";
import { notFound } from "next/navigation";

export default async function Page({ params }: { params: { id: string } }) {
  const id = params.id;
  const [invoice, customers] = await Promise.all([
    fetchInvoiceById(id),
    fetchCustomers(),
  ]);

  if (!invoice) {
    notFound();
  }

  // ...
}
```

接著，為了向使用者顯示錯誤 UI，請在 `/edit` 資料夾內建立一個 `not-found.tsx` 檔案。

![not-found 檔案結構](https://nextjs.org/_next/image?url=https%3A%2F%2Fh8DxKfmAPhn8O0p3.public.blob.vercel-storage.com%2Flearn%2Fdark%2Fnot-found-file.png&w=3840&q=75)

在 `not-found.tsx` 檔案內，貼上以下程式碼：

`/app/dashboard/invoices/[id]/edit/not-found.tsx`

```tsx
import Link from "next/link";
import { FaceFrownIcon } from "@heroicons/react/24/outline";

export default function NotFound() {
  return (
    <main className="flex h-full flex-col items-center justify-center gap-2">
      <FaceFrownIcon className="w-10 text-gray-400" />
      <h2 className="text-xl font-semibold">404 Not Found</h2>
      <p>Could not find the requested invoice.</p>
      <Link
        href="/dashboard/invoices"
        className="mt-4 rounded-md bg-blue-500 px-4 py-2 text-sm text-white transition-colors hover:bg-blue-400"
      >
        Go Back
      </Link>
    </main>
  );
}
```

重新整理該路由，您現在應該會看到以下 UI。

值得記住的是，`notFound` 將優先於 `error.tsx`，所以當您想要處理更具體的錯誤時，可以使用它！

## 延伸閱讀

要了解更多關於 Next.js 中錯誤處理的資訊，請查看以下文件：

- [錯誤處理 (Error Handling)](https://nextjs.org/docs/app/building-your-application/routing/error-handling)
- [`error.js` API 參考](https://nextjs.org/docs/app/api-reference/file-conventions/error)
- [`notFound()` API 參考](https://nextjs.org/docs/app/api-reference/functions/not-found)
- [`not-found.js` API 參考](https://nextjs.org/docs/app/api-reference/file-conventions/not-found)

```

```
